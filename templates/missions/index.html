{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load crispy_forms_tags %}
{% load markdownify %}

{% block opengraph %}
    <meta property="og:url"           content="https://engajaflix.club/" />
    <meta property="og:type"          content="website" />
    <meta property="og:title"         content="Engajaflix" />
    <meta property="og:description"   content='{% translate "Daily missions to improve your brand's communication" %}' />
    <meta property="og:image"         content="{% static "/img/logo.png" %}" />
{% endblock %}
{% block content %}
    <div class="row mt-3 mb-3 d-flex justify-content-center">
        <div class="col text-center">
            {% if mission %}
                {% if has_sent %}
                    <h2>{% translate "Congratulations on completing today's mission!" %}</h2>
                    <div class="mt-3 mb-3">
                        <button class="btn btn-primary" id="share">{% translate "Share " %}<i class="bi bi-share-fill"></i></button>
                    </div>
                    <div class="alert alert-success alert-dismissible fade show" role="alert" id="copy-alert">
                        {% translate "Results copied to clipboard" %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="X"></button>
                    </div>
                    <p>{% translate "The next mission will be available in " %}</p>
                    <h1><noscript>{{ next_mission }} seconds</noscript><span id="countdown"></span></h1>
                    <div class="mt-1 mb-1">
                        <img src="{% static "/img/dog_champagne.gif" %}" class="img-fluid" alt="cute dog with champagne glass" />
                    </div>
                {% else %}
                    <h2>{% translate "Mission #" %}{{ mission.number }}:</h2>
                    <h4>{{ mission.day }} - {{ mission.title }}</h4>
                    <p>{{ mission.description|markdownify }}</p>
                    {% crispy form %}
                {% endif %}
            {% else %}
                <h1>{% translate "You've seen all we've got, but there is sure more coming." %}</h1>
                <div class="mt-1 mb-1">
                    <img src="{% static "/img/will_find.gif" %}" class="img-fluid" alt="will smith magnifying glass" />
                </div>
            {% endif %}
            <span>
                {% if not user.is_authenticated %}
                    <a class="btn btn-secondary" href="{% url "register" %}">{% translate "Register" %}</a>
                {% endif %}
                <a class="btn btn-light" href="{% url "coming_soon" %}">{% translate "Coming Soon" %}</a>
                {% if not user.is_authenticated %}
                    <a class="btn btn-secondary" href="{% url "login" %}">{% translate "Login" %}</a>
                {% endif %}
            </span>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const translateSecs = (secs) => {
            let diff = secs;
            const hours = Math.floor(diff / 3600) % 24;
            diff -= hours * 3600;
            const minutes = Math.floor(diff / 60) % 60;
            diff -= minutes * 60;
            const seconds = Math.floor(diff) % 60;
            return `${hours}h ${minutes}m ${seconds}s`;
        }
        $(document).ready(function () {
            let targetSecs = Number("{{ next_mission }}");
            $("#copy-alert").hide();
            let shareText = "{{ share_text }}";
            $("#countdown").text(translateSecs(targetSecs));
            setInterval(function () {
                targetSecs -= 1;
                $("#countdown").text(translateSecs(targetSecs));
            }, 1000);

            $("#share").on('click', async () => {
               if (navigator.canShare && navigator.canShare({ text: ''})) {
                   await navigator.share({text: shareText});
               } else {
                   await navigator.clipboard.writeText(shareText);
                   $("#copy-alert").show();
               }
            });
        })
    </script>
{% endblock %}